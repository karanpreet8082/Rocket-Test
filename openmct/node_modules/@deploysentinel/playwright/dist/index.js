"use strict";var j=require("fs"),Q=require("os"),X=require("lodash/pick"),n=require("@deploysentinel/debugger-core");require("dotenv/config");var Z=require("@achrinza/node-ipc"),ee=require("adm-zip"),te=require("lodash/merge"),ae=require("@babel/code-frame");function v(r){return r&&typeof r=="object"&&"default"in r?r:{default:r}}var re=v(j),N=v(Q),se=v(X),p=v(Z),oe=v(ee),x=v(te),A,q;const C=n.utils.createRandomID(),w=process.env.DEPLOYSENTINEL_API_KEY,O=(A=process.env.DEPLOYSENTINEL_API_URL)!=null?A:"https://api.deploysentinel.com/ci",R=n.utils.stringToBoolean(process.env.DEPLOYSENTINEL_LOG_VERBOSE);n.utils.stringToBoolean((q=process.env.DEPLOYSENTINEL_REMOTE_DEBUGGING)!=null?q:"1");const ne=O.includes("api.deploysentinel.com"),B="playwright";var ie=Object.defineProperty,le=Object.defineProperties,de=Object.getOwnPropertyDescriptors,L=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,M=(r,e,t)=>e in r?ie(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,S=(r,e)=>{for(var t in e||(e={}))ue.call(e,t)&&M(r,t,e[t]);if(L)for(var t of L(e))ce.call(e,t)&&M(r,t,e[t]);return r},pe=(r,e)=>le(r,de(e));class me extends n.api.APIClientBase{constructor(e){super(e)}setTestConfig(e){this.testConfig=S(S({},this.testConfig),e)}getTestConfig(){return this.testConfig}async createRun(e){let t;try{return t=(await this.axiosInstance.post("/run",pe(S({},e),{testFramework:B,batchId:this.buildId,debuggerVersion:this.debuggerVersion,testConfig:this.testConfig}))).data,t}catch(s){return this.logger.error({message:s,location:"APIClient:createRun",meta:{runPayload:e}}),t}}async patchRun(e,t){try{await this.axiosInstance.patch(`/run/${e}`,t)}catch(s){this.logger.error({message:s,location:"APIClient:patchRun",meta:{runId:e,runPayload:t}})}}async sendReport(e,t,s){try{await this.axiosInstance.post("/report",{buildId:this.buildId,ciProvider:e,commentInfo:t,runResults:s,debuggerVersion:this.debuggerVersion,testFramework:"playwright"})}catch(o){this.logger.error({message:o,location:"APIClient:sendReport",meta:{ciProvider:e,commentInfo:t,runResults:s}})}}}var he=Object.defineProperty,ge=Object.defineProperties,fe=Object.getOwnPropertyDescriptors,U=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable,F=(r,e,t)=>e in r?he(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,T=(r,e)=>{for(var t in e||(e={}))ye.call(e,t)&&F(r,t,e[t]);if(U)for(var t of U(e))ve.call(e,t)&&F(r,t,e[t]);return r},be=(r,e)=>ge(r,fe(e));const E=(r,e,t)=>new Promise((s,o)=>{const l=`${Math.floor(Math.random()*1e6)}`,m=setTimeout(()=>{o(new Error("IPC Request Timed Out"))},1e4),i=h=>{h.reqId==l&&(clearTimeout(m),r.off(`RES_${e}`,i),s(h.payload))};r.on(`RES_${e}`,i),r.emit(e,{reqId:l,payload:t})});class V extends n.api.APIClientBase{constructor(e){super(e),this.createRun=async t=>{let s=null;try{return s=await E(this.server,"POST_RUN",be(T({},t),{testFramework:B,batchId:this.buildId,debuggerVersion:this.debuggerVersion,testConfig:this.testConfig})),s}catch(o){return p.default.log("Error while creating run",o),s}},this.patchRun=async(t,s)=>{try{await E(this.server,"PATCH_RUN",T({_id:t},s))}catch(o){p.default.log("Error while patching run",o)}},this.sendMessage=async(t,s,o)=>{},this.uploadToS3=async(t,s,o)=>{if(JSON.parse(t).type!=="internal")try{await E(this.server,"POST_UPLOAD",{url:t,file:s})}catch(l){p.default.log("Error while uploading artifacts",l)}},p.default.config.silent=!e.verbose,p.default.config.appspace="com.deploysentinel.playwright-open.",p.default.config.retry=1500,p.default.connectTo("server",()=>{this.server=p.default.of.server,this.server.on("connect",()=>{p.default.log("## connected to server ##"),this.server.emit("welcome","hello")}),this.server.on("disconnect",()=>{p.default.log("disconnected from world")})})}setTestConfig(e){this.testConfig=T(T({},this.testConfig),e)}getTestConfig(){return this.testConfig}async sendReport(...e){return!0}}const we=r=>{console.log("\x1B[33m",`DeploySentinel Reporter: ${r}`,"\x1B[0m")},G=r=>{const[e,t]=n.utils.jsonStringify(r);return e!==null?[e,t]:n.utils.useTry(()=>n.utils.pack(t))},Y=(r,e)=>`${r}:${e}`,Te=r=>{switch(r){case"skipped":return n.Types.RunState.Pending;case"passed":return n.Types.RunState.Passed;case"failed":return n.Types.RunState.Failed;case"timedOut":return n.Types.RunState.Failed;case"interrupted":return n.Types.RunState.TimedOut;default:throw Error(`Unrecognized test status ${r}`)}};var Ie=Object.defineProperty,Pe=Object.defineProperties,Ce=Object.getOwnPropertyDescriptors,J=Object.getOwnPropertySymbols,Oe=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable,K=(r,e,t)=>e in r?Ie(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,I=(r,e)=>{for(var t in e||(e={}))Oe.call(e,t)&&K(r,t,e[t]);if(J)for(var t of J(e))Re.call(e,t)&&K(r,t,e[t]);return r},Se=(r,e)=>Pe(r,Ce(e));class Ee{constructor(e,t,s,o){this.dsRun=e,this.attachments=t,this.logger=s,this.uploadToS3=o??n.api.uploadToS3}getJSONArrayData(e){return e.getData().toString("utf8").split(`
`).map(t=>{const[s,o]=n.utils.useTry(()=>JSON.parse(t));return o}).filter(t=>t!==null)}readResource(e,{mimeType:t,compression:s,_sha1:o}){return o?e.readAsText(`resources/${o}`):null}async start(){var e;const t=this.attachments.filter(u=>u.path).map(u=>new oe.default(u.path)),s=new n.utils.EventsHandler,o=new n.utils.EventsHandler;for(const u of t){const g=n.utils.createRandomID(),W=u.getEntries();let $=[],D=[];for(const a of W)a.entryName.includes(".trace")?$=this.getJSONArrayData(a):a.entryName.includes(".network")&&(D=this.getJSONArrayData(a));let f=null;for(const a of $)switch(a.type){case"event":{f===null&&a?.metadata!=null&&(f=a),a?.metadata!=null&&a.metadata.type==="ConsoleMessage"&&s.push({type:"console",id:n.utils.createRandomID(),offset:a.metadata.startTime,ts:a.metadata.wallTime,data:{dsContextId:g,pageId:a.metadata.pageId,frameId:a.metadata.frameId,pw_method:a.metadata.method,pw_params:a.metadata.params}});break}case"action":{if(a?.metadata!=null&&!a.metadata.internal&&!a.metadata.method.startsWith("tracing")){const d=Boolean(a.metadata.error),y=a.metadata.log;d&&(e=a.metadata.stack)!=null&&e[0]&&y.push(`

`+ae.codeFrameColumns(this.dsRun.code,{start:{line:a.metadata.stack[0].line,column:a.metadata.stack[0].column}},{highlightCode:!0}));const k=n.utils.createRandomID();o.push({type:"log",id:k,offset:a.metadata.startTime,ts:a.metadata.wallTime,data:I({id:a.metadata.id,name:a.metadata.apiName,dsContextId:g,pageId:a.metadata.pageId,frameId:a.metadata.frameId,pw_params:a.metadata.params,pw_log:a.metadata.log},d&&{err:{name:a.metadata.error.error.message,stack:y}}),took:Math.round(a.metadata.endTime-a.metadata.startTime)}),s.push({type:"log",id:k,offset:a.metadata.startTime,ts:a.metadata.wallTime,data:{name:a.metadata.apiName}})}break}case"frame-snapshot":{o.push({type:"frame-snapshot",id:n.utils.createRandomID(),offset:a.snapshot.timestamp,ts:f?f.metadata.wallTime+Math.round(a.snapshot.timestamp-f.metadata.startTime):0,data:Se(I({},a.snapshot),{dsContextId:g})});break}}for(const a of D)a.type==="resource-snapshot"&&s.push({type:"network",id:n.utils.createRandomID(),offset:a.snapshot._monotonicTime,ts:f?f.metadata.wallTime+Math.round(a.snapshot._monotonicTime-f.metadata.startTime):new Date(a.snapshot.startedDateTime).getTime(),data:{dsContextId:g,frameId:a.snapshot._frameref,req:I({timestamp:0,url:a.snapshot.request.url,method:a.snapshot.request.method,headers:a.snapshot.request.headers.map(d=>({[d.name]:d.value})).reduce((d,y)=>x.default(d,y),{}),queryString:a.snapshot.request.queryString},a.snapshot.request.postData&&{body:this.readResource(u,a.snapshot.request.postData)}),res:I({timestamp:a.snapshot.time/1e3,statusCode:a.snapshot.response.status,statusMessage:a.snapshot.response.statusText,headers:a.snapshot.response.headers.map(d=>({[d.name]:d.value})).reduce((d,y)=>x.default(d,y),{})},a.snapshot.response.content&&{body:this.readResource(u,a.snapshot.response.content)})},took:a.snapshot.time})}const[l,m]=G(s.get().sort((u,g)=>u.offset-g.offset));l!==null&&this.logger.error({message:"failed in stringifying network events",location:"TraceProcessor.start",meta:{run:this.dsRun}});const[i,h]=G({events:[...o.get().sort((u,g)=>u.offset-g.offset),n.utils.createDeploySentinelEvent("log",{name:"End of Test",message:""})]});i!==null&&this.logger.error({message:"failed in stringifying log events",location:"TraceProcessor.start",meta:{run:this.dsRun}});const c=this.attachments[0],[b,P]=n.utils.useTry(()=>j.readFileSync(c.path));b!==null&&this.logger.error({message:"failed in reading trace.zip file",location:"TraceProcessor.start",meta:{error:b,attachment:{name:c.name,path:c.path,contentType:c.contentType},run:this.dsRun}}),await Promise.all([this.uploadToS3(this.dsRun.s3PresignedUrls.browser,h,this.logger),this.uploadToS3(this.dsRun.s3PresignedUrls.plugin,m,this.logger),this.uploadToS3(this.dsRun.s3PresignedUrls.internal,P,this.logger)])}}var _="0.3.4",_e=Object.defineProperty,H=Object.getOwnPropertySymbols,$e=Object.prototype.hasOwnProperty,De=Object.prototype.propertyIsEnumerable,z=(r,e,t)=>e in r?_e(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ke=(r,e)=>{for(var t in e||(e={}))$e.call(e,t)&&z(r,t,e[t]);if(H)for(var t of H(e))De.call(e,t)&&z(r,t,e[t]);return r};class je{constructor(){this.enabled=Boolean(w),this.isIpc=w==="LOCAL_IPC",this.ciProvider=n.ciProviders.provider(),this.apiClient=this.isIpc?new V({apiKey:w,baseUrl:O,buildId:C,debuggerVersion:_,verbose:R}):new me({apiKey:w,baseUrl:O,buildId:C,debuggerVersion:_,verbose:R}),this.logger=new n.api.Logger(this.apiClient,R),this.gitClient=new n.GitClient(this.logger),this.runsPromise=new Map,this.promises=[],we(`[v${_}] is ${this.enabled?"enabled":"disabled (key not found)"}`)}wrap({event:e,handler:t,log:s}){if(this.enabled)try{s&&this.logger.info({location:e,message:`entering browser ${e} hook`}),t()}catch(o){console.error(o),this.logger.error({location:e,message:o.message})}finally{s&&this.logger.info({location:e,message:`exiting browser ${e} hook`})}}async wrapAsync({event:e,handler:t,log:s}){if(this.enabled)try{s&&this.logger.info({location:e,message:`entering browser ${e} hook`}),await t()}catch(o){console.error(o),this.logger.error({location:e,message:o.message})}finally{s&&this.logger.info({location:e,message:`exiting browser ${e} hook`})}}printsToStdio(){return!1}onBegin(e,t){this.wrap({event:"onBegin",log:!0,handler:()=>{this.apiClient.setTestConfig(se.default(e,["fullyParallel","globalTimeout","maxFailures","preserveOutput","quiet","reporter","shard","updateSnapshots","version","workers"]))}})}onTestBegin(e,t){this.wrap({event:"onTestBegin",log:!0,handler:()=>{const s=t.retry,o=Y(e.id,s),[l,m,i,...h]=e.titlePath();this.apiClient.setTestConfig({group:m});const c=Promise.all([re.default.promises.readFile(e.location.file,"utf8"),this.gitClient.getCommitInfo()]).then(([b,P])=>this.apiClient.createRun({batchId:C,code:b,name:h.join(" "),retryNumber:s,startedAt:t.startTime,testName:i,commitInfo:P,ciProvider:this.ciProvider}));this.runsPromise.set(o,c)}})}onTestEnd(e,t){this.wrap({event:"onTestEnd",log:!0,handler:()=>{const s=Y(e.id,t.retry),o=t.attachments.filter(i=>i.name==="trace"&&i.contentType==="application/zip"),l=t.status==="failed"||t.status==="timedOut",m=this.runsPromise.get(s);m&&this.promises.push(m.then(i=>{if(i){const h=o.length>0;let c;return h&&(this.isIpc==!1&&console.log("\x1B[35m","DeploySentinel",`\x1B[0mDebug URL: ${n.utils.getDebuggerUrl(i._id,!ne)}
	${l?"\x1B[31mx\x1B[0m":"\x1B[32m\u2713\x1B[0m"} ${e.title}`),c=new Ee(i,o,this.logger,this.isIpc&&this.apiClient instanceof V?this.apiClient.uploadToS3:void 0)),Promise.all([c?.start(),this.apiClient.patchRun(i._id,ke({completedAt:new Date(t.startTime.getTime()+t.duration),took:t.duration,state:Te(t.status)},t.error&&{errorTrace:{message:t.error.message,name:t.error.value,stack:t.error.stack}}))])}}))}})}async onEnd(e){await this.wrapAsync({event:"onEnd",log:!0,handler:async()=>{const t=await Promise.allSettled(this.promises);for(const l of t)l.status==="rejected"&&this.logger.error({message:l.reason,location:"onEnd"});const s=this.apiClient.getTestConfig(),o=await this.gitClient.getCommitInfo();await this.apiClient.sendReport(this.ciProvider,o,{browserName:s.group,browserVersion:null,osName:N.default.platform(),osVersion:N.default.release(),testFrameworkVersion:s.version})}})}}module.exports=je;
